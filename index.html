<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Device Location Tracker</title>
    <link rel="stylesheet" href="style.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
      #loader {
        display: none;
        margin-top: 10px;
      }
      .row-error {
        background-color: #fdd;
      }
      .status-success {
        color: green;
      }
      .status-error {
        color: red;
      }
    </style>
  </head>

  <body>
    <h2>Device GPS Tracker</h2>

    <div>
      <button onclick="addAllDevices()">Get All Devices</button>
      <button onclick="exportAllToExcel()">Export All to Excel</button>
      <div style="margin-top: 10px">
        <input
          type="text"
          id="coordInput"
          placeholder="Latitude, Longitude"
          style="width: 200px"
        />
        <button onclick="addCoordinatesFromSingleInput()">
          Add Coordinates
        </button>
      </div>
      <input type="file" id="fileUpload" accept=".xlsx" />
      <button onclick="handleFileUpload()">Upload and Convert</button>

      <div id="loader">Fetching device data...</div>
    </div>

    <table
      id="deviceTable"
      border="1"
      cellspacing="0"
      cellpadding="5"
      style="margin-top: 10px"
    >
      <thead>
        <tr>
          <th>ID</th>
          <th>Coordinates</th>
          <th>Village</th>
          <th>Commune</th>
          <th>District</th>
          <th>City / Province</th>
          <th>Full Address</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <script>
      const mockDevices = [
        { lat: 12.054140555556, lng: 105.15349055556 },
        { lat: 12.054871111111, lng: 105.162565 },
        { lat: 11.545833333333, lng: 104.89939333333 },
        { lat: 11.590175, lng: 104.88211333333 },
        { lat: 11.599270555556, lng: 104.91861166667 },
        { lat: 11.896451111111, lng: 106.33732277778 },
        { lat: 11.462361111111, lng: 104.95522166667 },
        { lat: 10.489267222222, lng: 104.29446111111 },
        { lat: 11.596908, lng: 104.914567 },
        { lat: 11.565896111111, lng: 104.91824166667 },
        { lat: 10.615309444444, lng: 103.49840388889 },
      ];

      const devices = [];
      let nextId = 1;

      async function addCoordinatesFromSingleInput() {
        const coordStr = document.getElementById("coordInput").value.trim();

        const parts = coordStr.split(",").map((s) => s.trim());

        if (parts.length !== 2) {
          alert("Please enter coordinates in 'latitude, longitude' format.");
          return;
        }

        const lat = parseFloat(parts[0]);
        const lng = parseFloat(parts[1]);

        if (isNaN(lat) || isNaN(lng)) {
          alert("Please enter valid numbers for latitude and longitude.");
          return;
        }

        document.getElementById("loader").style.display = "block";

        const result = await getDetailedAddress(lat, lng);

        devices.push({
          id: nextId++,
          lat,
          lng,
          timestamp: new Date().toLocaleString(),
          ...result,
        });

        renderTable();
        document.getElementById("loader").style.display = "none";

        document.getElementById("coordInput").value = "";
      }

      function handleFileUpload() {
        const fileInput = document.getElementById("fileUpload");
        const file = fileInput.files[0];

        if (!file) {
          alert("Please select an .xlsx file.");
          return;
        }

        const reader = new FileReader();
        reader.onload = async function (e) {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: "array" });
          const sheetName = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[sheetName];
          const json = XLSX.utils.sheet_to_json(worksheet);

          const coordList = json
            .filter((row) => row["Last connection"])
            .map((row) => {
              const parts = String(row["Last connection"]).split(",");
              return {
                lat: parseFloat(parts[0]),
                lng: parseFloat(parts[1]),
              };
            });

          document.getElementById("loader").style.display = "block";

          for (const coord of coordList) {
            if (!isNaN(coord.lat) && !isNaN(coord.lng)) {
              const result = await getDetailedAddress(coord.lat, coord.lng);
              devices.push({
                id: nextId++,
                lat: coord.lat,
                lng: coord.lng,
                timestamp: new Date().toLocaleString(),
                ...result,
              });
            }
          }

          renderTable();
          document.getElementById("loader").style.display = "none";
          fileInput.value = "";
        };

        reader.readAsArrayBuffer(file);
      }

      async function addAllDevices() {
        document.getElementById("loader").style.display = "block";
        devices.length = 0;
        nextId = 1;

        const addressPromises = mockDevices.map((device) =>
          getDetailedAddress(device.lat, device.lng)
        );

        const results = await Promise.all(addressPromises);

        for (let i = 0; i < results.length; i++) {
          devices.push({
            id: nextId++,
            ...mockDevices[i],
            timestamp: new Date().toLocaleString(),
            ...results[i],
          });
        }

        renderTable();
        document.getElementById("loader").style.display = "none";
      }

      async function getDetailedAddress(lat, lng) {
        try {
          if (isNaN(lat) || isNaN(lng)) {
            return {
              address: "Invalid coordinates",
              phum: "",
              khum: "",
              srok: "",
              city: "",
              status: "Error: Invalid coordinates",
            };
          }

          const response = await fetch(
            `https://maps.googleapis.com/maps/api/geocode/json?latlng=${lat},${lng}&key=AIzaSyCNLJoByCegi307pESD4Hd3EJ2TIiTwb7M`
          );
          const data = await response.json();

          if (
            data.status !== "OK" ||
            !data.results ||
            data.results.length === 0
          ) {
            return {
              address: "Address not found",
              phum: "",
              khum: "",
              srok: "",
              city: "",
              status: `Error: ${data.status || "No result returned"}`,
            };
          }

          const result = data.results[0];
          const components = result.address_components;

          const getComp = (type) =>
            components.find((c) => c.types.includes(type))?.long_name || "";

          const cityRaw =
            getComp("administrative_area_level_1")
              .replace(/Province/i, "")
              .trim() || "N/A";

          let khumRaw =
            getComp("administrative_area_level_3") ||
            getComp("locality") ||
            getComp("sublocality") ||
            getComp("neighborhood") ||
            "N/A";

          if (
            cityRaw.toLowerCase() === "phnom penh" ||
            cityRaw.toLowerCase() === "sihanoukville"
          ) {
            khumRaw = "N/A";
          }

          return {
            address: result.formatted_address,
            phum: getComp("sublocality") || getComp("neighborhood") || "N/A",
            khum: khumRaw,
            srok: getComp("administrative_area_level_2") || "N/A",
            city: cityRaw,
            status: "Success",
          };
        } catch (error) {
          console.error("Geocode error:", error);
          return {
            address: "Error",
            phum: "",
            khum: "",
            srok: "",
            city: "",
            status: `Error: ${error.message || "Fetch failed"}`,
          };
        }
      }

      function renderTable() {
        const tbody = document.querySelector("#deviceTable tbody");
        tbody.innerHTML = "";

        devices.forEach((dev) => {
          const row = document.createElement("tr");

          if (dev.status !== "Success") {
            row.classList.add("row-error");
          }

          row.innerHTML = `
            <td>${dev.id}</td>
            <td>${dev.lat}, ${dev.lng}</td>
            <td>${dev.phum || "N/A"}</td>
            <td>${dev.khum || "N/A"}</td>
            <td>${dev.srok || "N/A"}</td>
            <td>${dev.city || "N/A"}</td>
            <td>${dev.address || "N/A"}</td>
            <td class="${
              dev.status === "Success" ? "status-success" : "status-error"
            }">
              ${dev.status}
            </td>
          `;

          tbody.appendChild(row);
        });
      }

      function exportAllToExcel() {
        if (devices.length === 0) {
          alert("No device data available.");
          return;
        }

        // Prepare data for Excel
        const data = [
          [
            "Coordinates",
            "Village (Phum)",
            "Commune (Khum)",
            "District (Srok)",
            "City",
            "Full Address",
            "Status",
            "Timestamp",
          ],
          ...devices.map((d) => [
            `${d.lat}, ${d.lng}`,
            d.phum || "N/A",
            d.khum || "N/A",
            d.srok || "N/A",
            d.city || "N/A",
            d.address || "N/A",
            d.status,
            d.timestamp,
          ]),
        ];

        // Create worksheet and workbook
        const worksheet = XLSX.utils.aoa_to_sheet(data);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "Device Data");

        // Export as .xlsx file
        XLSX.writeFile(workbook, "device_report.xlsx");
      }
    </script>
  </body>
</html>
