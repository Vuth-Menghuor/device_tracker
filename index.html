<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Device Location Tracker</title>
    <link rel="stylesheet" href="style.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
      #loader {
        display: none;
        margin-top: 10px;
      }
      .row-error {
        background-color: #fdd;
      }
      .status-success {
        color: green;
      }
      .status-error {
        color: red;
      }
      .status-offline {
        color: orange;
      }
      .status-online {
        color: blue;
      }
      #deviceTable {
        font-size: 12px;
      }
    </style>
  </head>

  <body>
    <h2>Device GPS Tracker</h2>

    <div>
      <button onclick="exportAllToCSV()">Export All to CSV</button>
      <div style="margin-top: 10px">
        <input
          type="text"
          id="coordInput"
          placeholder="Latitude, Longitude"
          style="width: 200px"
        />
        <input
          type="text"
          id="imeiInput"
          placeholder="IMEI (optional)"
          style="width: 150px; margin-left: 5px"
        />
        <button onclick="addCoordinatesFromSingleInput()">
          Add Coordinates
        </button>
      </div>
      <input type="file" id="fileUpload" accept=".xlsx,.csv" />
      <button onclick="handleFileUpload()">Upload and Convert</button>

      <div id="loader">Fetching device data...</div>
    </div>

    <table
      id="deviceTable"
      border="1"
      cellspacing="0"
      cellpadding="5"
      style="margin-top: 10px; width: 100%"
    >
      <thead>
        <tr>
          <th>ID</th>
          <th>IMEI</th>
          <th>Coordinates</th>
          <th>Data Status</th>
          <th>Data Status Description</th>
          <th>Village</th>
          <th>Commune</th>
          <th>District</th>
          <th>City / Province</th>
          <th>Geocode Status</th>
        </tr>
      </thead>

      <tbody></tbody>
    </table>

    <script>
      const devices = [];
      let nextId = 1;

      function generateRandomIMEI() {
        const base = "35513908508";
        const suffix = Math.floor(Math.random() * 10000)
          .toString()
          .padStart(4, "0");
        return base + suffix;
      }

      async function addCoordinatesFromSingleInput() {
        const coordStr = document.getElementById("coordInput").value.trim();
        const imeiStr = document.getElementById("imeiInput").value.trim();

        const parts = coordStr.split(",").map((s) => s.trim());

        if (parts.length !== 2) {
          alert("Please enter coordinates in 'latitude, longitude' format.");
          return;
        }

        const lat = parseFloat(parts[0]);
        const lng = parseFloat(parts[1]);

        if (isNaN(lat) || isNaN(lng)) {
          alert("Please enter valid numbers for latitude and longitude.");
          return;
        }

        document.getElementById("loader").style.display = "block";

        const result = await getDetailedAddress(lat, lng);

        devices.push({
          id: nextId++,
          imei: imeiStr || generateRandomIMEI(),
          lat,
          lng,
          timestamp: new Date().toLocaleString(),
          ...result,
        });

        renderTable();
        document.getElementById("loader").style.display = "none";

        document.getElementById("coordInput").value = "";
        document.getElementById("imeiInput").value = "";
      }

      function handleFileUpload() {
        const fileInput = document.getElementById("fileUpload");
        const file = fileInput.files[0];

        if (!file) {
          alert("Please select a .xlsx or .csv file.");
          return;
        }

        const fileName = file.name.toLowerCase();

        if (fileName.endsWith(".csv")) {
          handleCSVUpload(file);
        } else if (fileName.endsWith(".xlsx")) {
          handleExcelUpload(file);
        } else {
          alert("Please select a valid .xlsx or .csv file.");
        }
      }

      function handleCSVUpload(file) {
        Papa.parse(file, {
          header: true,
          skipEmptyLines: true,
          complete: async function (results) {
            if (results.errors.length > 0) {
              console.warn("CSV parsing errors:", results.errors);
            }

            const coordList = results.data
              .filter((row) => row["Last connection"] || row["Coordinates"])
              .map((row) => {
                const coordStr =
                  row["Last connection"] || row["Coordinates"] || "";
                const parts = String(coordStr).split(",");
                return {
                  lat: parseFloat(parts[0]),
                  lng: parseFloat(parts[1]),
                };
              });

            document.getElementById("loader").style.display = "block";

            for (const row of results.data) {
              const coordStr =
                row["Last connection"] || row["Coordinates"] || "";
              const parts = String(coordStr).split(",");
              const lat = parseFloat(parts[0]);
              const lng = parseFloat(parts[1]);

              if (!isNaN(lat) && !isNaN(lng)) {
                const result = await getDetailedAddress(lat, lng);
                devices.push({
                  id: nextId++,
                  imei:
                    row["IMEI"] ||
                    row["imei"] ||
                    row["Imei"] ||
                    generateRandomIMEI(),
                  lat,
                  lng,
                  datastatus: row["datastatus"] || "N/A",
                  datastatus_description:
                    row["datastatus_description"] || "N/A",
                  timestamp: new Date().toLocaleString(),
                  ...result,
                });
              }
            }

            renderTable();
            document.getElementById("loader").style.display = "none";
            document.getElementById("fileUpload").value = "";
          },
        });
      }

      function handleExcelUpload(file) {
        const reader = new FileReader();
        reader.onload = async function (e) {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: "array" });
          const sheetName = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[sheetName];
          const json = XLSX.utils.sheet_to_json(worksheet);

          const coordList = json
            .filter((row) => row["Last connection"] || row["Coordinates"])
            .map((row) => {
              const coordStr =
                row["Last connection"] || row["Coordinates"] || "";
              const parts = String(coordStr).split(",");
              return {
                lat: parseFloat(parts[0]),
                lng: parseFloat(parts[1]),
              };
            });

          document.getElementById("loader").style.display = "block";

          for (const row of json) {
            const coordStr = row["Last connection"] || row["Coordinates"] || "";
            const parts = String(coordStr).split(",");
            const lat = parseFloat(parts[0]);
            const lng = parseFloat(parts[1]);

            if (!isNaN(lat) && !isNaN(lng)) {
              const result = await getDetailedAddress(lat, lng);
              devices.push({
                id: nextId++,
                imei:
                  row["IMEI"] ||
                  row["imei"] ||
                  row["Imei"] ||
                  generateRandomIMEI(),
                lat,
                lng,
                datastatus: row["datastatus"] || "N/A",
                datastatus_description: row["datastatus_description"] || "N/A",
                timestamp: new Date().toLocaleString(),
                ...result,
              });
            }
          }

          renderTable();
          document.getElementById("loader").style.display = "none";
          document.getElementById("fileUpload").value = "";
        };

        reader.readAsArrayBuffer(file);
      }

      const khmerToEnglishMap = {
        ខេត្តបន្ទាយមានជ័យ: "Banteay Meanchey",
        ខេត្តបាត់ដំបង: "Battambang",
        ខេត្តកំពង់ចាម: "Kampong Cham",
        ខេត្តកំពង់ឆ្នាំង: "Kampong Chhnang",
        ខេត្តកំពង់ស្ពឺ: "Kampong Speu",
        ខេត្តកំពង់ថ្ម: "Kampong Thom",
        ខេត្តកណ្ដាល: "Kandal",
        ខេត្តកែប: "Kep",
        ខេត្តកោះកុង: "Koh Kong",
        ខេត្តក្រចេះ: "Kratie",
        ខេត្តកំពត: "Kampot",
        ខេត្តព្រះវិហារ: "Preah Vihear",
        ខេត្តពោធិ៍សាត់: "Pursat",
        ខេត្តរតនគីរី: "Ratanakiri",
        ខេត្តសៀមរាប: "Siem Reap",
        ខេត្តស្ពាយបូរ: "Svay Rieng",
        ខេត្តតាកែវ: "Takeo",
        ខេត្តព្រះសីហនុ: "Sihanoukville",
        ខេត្តមណ្ឌលគីរី: "Mondulkiri",
        ខេត្តសែនសុខ: "Stung Treng",
        ខេត្តឧត្តរមានជ័យ: "Oddar Meanchey",
        រាជធានីភ្នំពេញ: "Phnom Penh",
      };

      async function getDetailedAddress(lat, lng) {
        try {
          const response = await fetch(
            `https://maps.googleapis.com/maps/api/geocode/json?latlng=${lat},${lng}&language=en&key=AIzaSyCNLJoByCegi307pESD4Hd3EJ2TIiTwb7M`
          );
          const data = await response.json();

          if (data.status !== "OK" || !data.results.length) {
            return {
              phum: "",
              khum: "",
              srok: "",
              city: "",
              geocodeStatus: `Error: ${data.status}`,
            };
          }

          const result = data.results[0];
          const components = result.address_components;

          const getComp = (type) => {
            const comp = components.find((c) => c.types.includes(type));
            return comp ? comp.long_name : "";
          };

          const cityRaw =
            getComp("administrative_area_level_1")
              .replace(/Province/i, "")
              .trim() || "N/A";

          let khumRaw =
            getComp("administrative_area_level_3") ||
            getComp("locality") ||
            getComp("sublocality") ||
            getComp("neighborhood") ||
            "N/A";

          return {
            phum:
              khmerToEnglishMap[
                getComp("sublocality") || getComp("neighborhood")
              ] ||
              getComp("sublocality") ||
              getComp("neighborhood") ||
              "N/A",
            khum: khmerToEnglishMap[khumRaw] || khumRaw,
            srok:
              khmerToEnglishMap[getComp("administrative_area_level_2")] ||
              getComp("administrative_area_level_2") ||
              "N/A",
            city: khmerToEnglishMap[cityRaw] || cityRaw,
            geocodeStatus: "Success",
          };
        } catch (error) {
          return {
            phum: "",
            khum: "",
            srok: "",
            city: "",
            geocodeStatus: `Error: ${error.message}`,
          };
        }
      }

      function renderTable() {
        const tbody = document.querySelector("#deviceTable tbody");
        tbody.innerHTML = "";

        devices.forEach((dev) => {
          const row = document.createElement("tr");

          if (dev.geocodeStatus !== "Success") {
            row.classList.add("row-error");
          }

          row.innerHTML = `
  <td>${dev.id}</td>
  <td>${dev.imei || "N/A"}</td>
  <td>${dev.lat}, ${dev.lng}</td>
  <td>${dev.datastatus || "N/A"}</td>
  <td>${dev.datastatus_description || "N/A"}</td>
  <td>${dev.phum || "N/A"}</td>
  <td>${dev.khum || "N/A"}</td>
  <td>${dev.srok || "N/A"}</td>
  <td>${dev.city || "N/A"}</td>
  <td class="${
    dev.geocodeStatus === "Success" ? "status-success" : "status-error"
  }">${dev.geocodeStatus}</td>
`;

          tbody.appendChild(row);
        });
      }

      function exportAllToCSV() {
        if (devices.length === 0) {
          alert("No device data available.");
          return;
        }

        const csvData = [
          [
            "IMEI",
            "Coordinates",
            "Data Status",
            "Data Status Description",
            "Village (Phum)",
            "Commune (Khum)",
            "District (Srok)",
            "City",
            "Geocode Status",
            "Timestamp",
          ],
          ...devices.map((d) => [
            d.imei || "N/A",
            `${d.lat}, ${d.lng}`,
            d.datastatus || "N/A",
            d.datastatus_description || "N/A",
            d.phum || "N/A",
            d.khum || "N/A",
            d.srok || "N/A",
            d.city || "N/A",
            d.geocodeStatus,
            d.timestamp,
          ]),
        ];

        const csv = Papa.unparse(csvData);
        const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", "device_report.csv");
        link.style.visibility = "hidden";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }
    </script>
  </body>
</html>
