<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Device Location Tracker</title>
    <style>
      .info-panel {
        margin-bottom: 20px;
        padding: 15px;
        background: #e3f2fd;
        border-radius: 8px;
        border-left: 4px solid #2196f3;
      }
    </style>
    <link rel="stylesheet" href="style.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  </head>

  <body>
    <h2>Device GPS Tracker</h2>

    <div class="info-panel">
      <strong>Expected CSV format:</strong> imei, coordiates, datastatus,
      datastatus_description, hearttime, hearttime_unix
    </div>

    <div class="controls">
      <input type="file" id="fileUpload" accept=".xlsx,.csv" />
      <button onclick="handleFileUpload()">Upload and Convert</button>
      <button onclick="exportAllToCSV()">Export All to CSV</button>
      <button onclick="clearData()">Clear All Data</button>

      <div id="loader">Processing device data...</div>
      <div id="status"></div>
    </div>

    <table
      id="deviceTable"
      border="1"
      cellspacing="0"
      cellpadding="5"
      style="margin-top: 10px; width: 100%"
    >
      <thead>
        <tr>
          <th>ID</th>
          <th>IMEI</th>
          <th>Coordinates</th>
          <th>Data Status</th>
          <th>Data Status Description</th>
          <th>Hearttime</th>
          <th>Hearttime Unix</th>
          <th>Village</th>
          <th>Commune</th>
          <th>District</th>
          <th>City / Province</th>
          <th>Geocode Status</th>
        </tr>
      </thead>

      <tbody></tbody>
    </table>

    <script>
      const devices = [];
      let nextId = 1;

      function updateStatus(message) {
        document.getElementById("status").textContent = message;
      }

      function handleFileUpload() {
        const fileInput = document.getElementById("fileUpload");
        const file = fileInput.files[0];

        if (!file) {
          alert("Please select a .xlsx or .csv file.");
          return;
        }

        const fileName = file.name.toLowerCase();

        if (fileName.endsWith(".csv")) {
          handleCSVUpload(file);
        } else if (fileName.endsWith(".xlsx")) {
          handleExcelUpload(file);
        } else {
          alert("Please select a valid .xlsx or .csv file.");
        }
      }

      function handleCSVUpload(file) {
        Papa.parse(file, {
          header: true,
          skipEmptyLines: true,
          dynamicTyping: false, // Keep as strings to preserve formatting
          complete: async function (results) {
            if (results.errors.length > 0) {
              console.warn("CSV parsing errors:", results.errors);
            }

            console.log("Parsed CSV data:", results.data);
            console.log("CSV headers:", results.meta.fields);

            document.getElementById("loader").style.display = "block";
            updateStatus("Processing coordinates...");

            let processedCount = 0;
            let errorCount = 0;

            for (const row of results.data) {
              // Handle different possible column names and trim whitespace
              const imei = (row["imei"] || row["IMEI"] || row["Imei"] || "")
                .toString()
                .trim();
              const lastConnection = (
                row["Last connection"] ||
                row["last connection"] ||
                row["Coordinates"] ||
                row["coordinates"] ||
                ""
              )
                .toString()
                .trim();
              const datastatus = (row["datastatus"] || row["Data Status"] || "")
                .toString()
                .trim();
              const datastatusDescription = (
                row["datastatus_description"] ||
                row["Data Status Description"] ||
                ""
              )
                .toString()
                .trim();
              const hearttime = (row["hearttime"] || row["Hearttime"] || "")
                .toString()
                .trim();
              const hearttimeUnix = (
                row["hearttime_unix"] ||
                row["Hearttime Unix"] ||
                row["hearttime_unix"] ||
                ""
              )
                .toString()
                .trim();

              console.log("Processing row:", {
                imei,
                lastConnection,
                datastatus,
                datastatusDescription,
                hearttime,
                hearttimeUnix,
              });

              if (!lastConnection) {
                console.warn("No coordinates found for IMEI:", imei);
                errorCount++;
                continue;
              }

              // Parse coordinates
              const parts = lastConnection.split(",");
              if (parts.length !== 2) {
                console.warn(
                  "Invalid coordinate format for IMEI:",
                  imei,
                  "Coordinates:",
                  lastConnection
                );
                errorCount++;
                continue;
              }

              const lat = parseFloat(parts[0].trim());
              const lng = parseFloat(parts[1].trim());

              if (isNaN(lat) || isNaN(lng)) {
                console.warn(
                  "Invalid coordinates for IMEI:",
                  imei,
                  "Lat:",
                  lat,
                  "Lng:",
                  lng
                );
                errorCount++;
                continue;
              }

              try {
                const result = await getDetailedAddress(lat, lng);
                devices.push({
                  id: nextId++,
                  imei: imei || "N/A",
                  lat,
                  lng,
                  datastatus: datastatus || "N/A",
                  datastatus_description: datastatusDescription || "N/A",
                  hearttime: hearttime || "N/A",
                  hearttime_unix: hearttimeUnix || "N/A",
                  timestamp: new Date().toLocaleString(),
                  ...result,
                });
                processedCount++;
                updateStatus(`Processed ${processedCount} devices...`);
              } catch (error) {
                console.error("Error processing device:", imei, error);
                errorCount++;
              }
            }

            renderTable();
            document.getElementById("loader").style.display = "none";
            updateStatus(
              `Completed: ${processedCount} devices processed, ${errorCount} errors`
            );
            document.getElementById("fileUpload").value = "";
          },
          error: function (error) {
            console.error("CSV parsing error:", error);
            document.getElementById("loader").style.display = "none";
            updateStatus("Error parsing CSV file");
          },
        });
      }

      function handleExcelUpload(file) {
        const reader = new FileReader();
        reader.onload = async function (e) {
          try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: "array" });
            const sheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[sheetName];
            const json = XLSX.utils.sheet_to_json(worksheet, { defval: "" });

            console.log("Parsed Excel data:", json);

            document.getElementById("loader").style.display = "block";
            updateStatus("Processing coordinates...");

            let processedCount = 0;
            let errorCount = 0;

            for (const row of json) {
              // Handle different possible column names and convert to string
              const imei = (row["imei"] || row["IMEI"] || row["Imei"] || "")
                .toString()
                .trim();
              const lastConnection = (
                row["Last connection"] ||
                row["last connection"] ||
                row["Coordinates"] ||
                row["coordinates"] ||
                ""
              )
                .toString()
                .trim();
              const datastatus = (row["datastatus"] || row["Data Status"] || "")
                .toString()
                .trim();
              const datastatusDescription = (
                row["datastatus_description"] ||
                row["Data Status Description"] ||
                ""
              )
                .toString()
                .trim();
              const hearttime = (row["hearttime"] || row["Hearttime"] || "")
                .toString()
                .trim();
              const hearttimeUnix = (
                row["hearttime_unix"] ||
                row["Hearttime Unix"] ||
                row["hearttime_unix"] ||
                ""
              )
                .toString()
                .trim();

              if (!lastConnection) {
                console.warn("No coordinates found for IMEI:", imei);
                errorCount++;
                continue;
              }

              const parts = lastConnection.split(",");
              if (parts.length !== 2) {
                console.warn("Invalid coordinate format for IMEI:", imei);
                errorCount++;
                continue;
              }

              const lat = parseFloat(parts[0].trim());
              const lng = parseFloat(parts[1].trim());

              if (isNaN(lat) || isNaN(lng)) {
                console.warn("Invalid coordinates for IMEI:", imei);
                errorCount++;
                continue;
              }

              try {
                const result = await getDetailedAddress(lat, lng);
                devices.push({
                  id: nextId++,
                  imei: imei || "N/A",
                  lat,
                  lng,
                  datastatus: datastatus || "N/A",
                  datastatus_description: datastatusDescription || "N/A",
                  hearttime: hearttime || "N/A",
                  hearttime_unix: hearttimeUnix || "N/A",
                  timestamp: new Date().toLocaleString(),
                  ...result,
                });
                processedCount++;
                updateStatus(`Processed ${processedCount} devices...`);
              } catch (error) {
                console.error("Error processing device:", imei, error);
                errorCount++;
              }
            }

            renderTable();
            document.getElementById("loader").style.display = "none";
            updateStatus(
              `Completed: ${processedCount} devices processed, ${errorCount} errors`
            );
            document.getElementById("fileUpload").value = "";
          } catch (error) {
            console.error("Excel parsing error:", error);
            document.getElementById("loader").style.display = "none";
            updateStatus("Error parsing Excel file");
          }
        };

        reader.readAsArrayBuffer(file);
      }

      const khmerToEnglishMap = {
        ខេត្តបន្ទាយមានជ័យ: "Banteay Meanchey",
        ខេត្តបាត់ដំបង: "Battambang",
        ខេត្តកំពង់ចាម: "Kampong Cham",
        ខេត្តកំពង់ឆ្នាំង: "Kampong Chhnang",
        ខេត្តកំពង់ស្ពឺ: "Kampong Speu",
        ខេត្តកំពង់ថ្ម: "Kampong Thom",
        ខេត្តកណ្ដាល: "Kandal",
        ខេត្តកែប: "Kep",
        ខេត្តកោះកុង: "Koh Kong",
        ខេត្តក្រចេះ: "Kratie",
        ខេត្តកំពត: "Kampot",
        ខេត្តព្រះវិហារ: "Preah Vihear",
        ខេត្តពោធិ៍សាត់: "Pursat",
        ខេត្តរតនគីរី: "Ratanakiri",
        ខេត្តសៀមរាប: "Siem Reap",
        ខេត្តស្ពាយបូរ: "Svay Rieng",
        ខេត្តតាកែវ: "Takeo",
        ខេត្តព្រះសីហនុ: "Sihanoukville",
        ខេត្តមណ្ឌលគីរី: "Mondulkiri",
        ខេត្តសែនសុខ: "Stung Treng",
        ខេត្តឧត្តរមានជ័យ: "Oddar Meanchey",
        រាជធានីភ្នំពេញ: "Phnom Penh",
      };

      async function getDetailedAddress(lat, lng) {
        try {
          const response = await fetch(
            `https://maps.googleapis.com/maps/api/geocode/json?latlng=${lat},${lng}&language=en&key=AIzaSyCNLJoByCegi307pESD4Hd3EJ2TIiTwb7M`
          );
          const data = await response.json();

          if (data.status !== "OK" || !data.results.length) {
            return {
              phum: "",
              khum: "",
              srok: "",
              city: "",
              geocodeStatus: `Error: ${data.status}`,
            };
          }

          const result = data.results[0];
          const components = result.address_components;

          const getComp = (type) => {
            const comp = components.find((c) => c.types.includes(type));
            return comp ? comp.long_name : "";
          };

          const cityRaw =
            getComp("administrative_area_level_1")
              .replace(/Province/i, "")
              .trim() || "N/A";

          let khumRaw =
            getComp("administrative_area_level_3") ||
            getComp("locality") ||
            getComp("sublocality") ||
            getComp("neighborhood") ||
            "N/A";

          return {
            phum: getComp("sublocality") || getComp("neighborhood") || "N/A",
            khum: khmerToEnglishMap[khumRaw] || khumRaw,
            srok:
              khmerToEnglishMap[getComp("administrative_area_level_2")] ||
              getComp("administrative_area_level_2") ||
              "N/A",
            city: khmerToEnglishMap[cityRaw] || cityRaw,
            geocodeStatus: "Success",
          };
        } catch (error) {
          return {
            phum: "",
            khum: "",
            srok: "",
            city: "",
            geocodeStatus: `Error: ${error.message}`,
          };
        }
      }

      function renderTable() {
        const tbody = document.querySelector("#deviceTable tbody");
        tbody.innerHTML = "";

        devices.forEach((dev) => {
          const row = document.createElement("tr");

          if (dev.geocodeStatus !== "Success") {
            row.classList.add("row-error");
          }

          row.innerHTML = `
        <td>${dev.id}</td>
        <td>${dev.imei || "N/A"}</td>
        <td>${dev.lat}, ${dev.lng}</td>
        <td>${dev.datastatus || "N/A"}</td>
        <td>${dev.datastatus_description || "N/A"}</td>
        <td>${dev.hearttime || "N/A"}</td>
        <td>${dev.hearttime_unix || "N/A"}</td>
        <td>${dev.phum || "N/A"}</td>
        <td>${dev.khum || "N/A"}</td>
        <td>${dev.srok || "N/A"}</td>
        <td>${dev.city || "N/A"}</td>
        <td class="${
          dev.geocodeStatus === "Success" ? "status-success" : "status-error"
        }">${dev.geocodeStatus}</td>
      `;

          tbody.appendChild(row);
        });

        updateStatus(`Displaying ${devices.length} devices`);
      }

      function exportAllToCSV() {
        if (devices.length === 0) {
          alert("No device data available.");
          return;
        }

        const csvData = [
          [
            "IMEI",
            "Coordinates",
            "Data Status",
            "Data Status Description",
            "Hearttime",
            "Hearttime Unix",
            "Village (Phum)",
            "Commune (Khum)",
            "District (Srok)",
            "City",
            "Geocode Status",
            "Timestamp",
          ],
          ...devices.map((d) => [
            d.imei || "N/A",
            `${d.lat}, ${d.lng}`,
            d.datastatus || "N/A",
            d.datastatus_description || "N/A",
            d.hearttime || "N/A",
            d.hearttime_unix || "N/A",
            d.phum || "N/A",
            d.khum || "N/A",
            d.srok || "N/A",
            d.city || "N/A",
            d.geocodeStatus,
            d.timestamp,
          ]),
        ];

        const csv = Papa.unparse(csvData);
        const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute(
          "download",
          `device_report_${new Date().toISOString().split("T")[0]}.csv`
        );
        link.style.visibility = "hidden";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        updateStatus("CSV export completed");
      }

      function clearData() {
        if (devices.length === 0) {
          alert("No data to clear.");
          return;
        }

        if (confirm("Are you sure you want to clear all device data?")) {
          devices.length = 0;
          nextId = 1;
          renderTable();
          updateStatus("All data cleared");
        }
      }
    </script>
  </body>
</html>
